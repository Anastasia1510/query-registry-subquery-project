specVersion: 0.2.0
name: subquery-query-registry-project
version: 1.0.0
description: ''
repository: ''
schema:
  file: ./schema.graphql
network:
  # Moonbase Alpha
  # genesisHash: '0x91bc6e169807aaa54802737e1c504b2577d4fafedd5a02c10293b1cd60e39527'
  # endpoint: wss://moonbeam-alpha.api.onfinality.io/public-ws
  # dictionary: https://api.subquery.network/sq/subquery/moonbase-alpha-dictionary

  # SQN testnet
  genesisHash: '0x6b18138563ba86208d17839ff4f48e2f1fcaddb520de82bb6a731bcb5e801e85'
  # endpoint: 'https://node-6901336963938430976.jm.onfinality.io/rpc?apikey=65f0a4da-7861-429b-a21d-fd42209f4d2f'
  endpoint: 'wss://sqtn.api.onfinality.io/public-ws'

  chaintypes:
    file: ./chaintypes.js

x-moonbeam: &moonbeam
  kind: substrate/Moonbeam
  startBlock: 48
  processor: &moonbeam-processor
    file: './node_modules/@subql/contract-processors/dist/moonbeam.js'
  assets:
    eraManager:
      file: ./node_modules/@subql/contract-sdk/publish/contracts/EraManager.json
    staking:
      file: ./node_modules/@subql/contract-sdk/publish/contracts/Staking.json
    indexerRegistry:
      file: ./node_modules/@subql/contract-sdk/publish/contracts/IndexerRegistry.json
    queryRegistry:
      file: ./node_modules/@subql/contract-sdk/publish/contracts/QueryRegistry.json
    planManager:
      file: ./node_modules/@subql/contract-sdk/publish/contracts/PlanManager.json

dataSources:
  - <<: *moonbeam
    processor:
      <<: *moonbeam-processor
      options:
        abi: eraManager
        address: '0xED8f079e89717A94ff9E72F04A8e2775161024FF'
    mapping:
      file: ./dist/index.js
      handlers:
        - handler: handleNewEra
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - NewEraStart(uint256 indexed era, address caller)
  - <<: *moonbeam
    processor:
      <<: *moonbeam-processor
      options:
        abi: indexerRegistry
        address: '0x6B30bf34254ca3dD79cACC425feddf376199e586'
    mapping:
      file: ./dist/index.js
      handlers:
        - handler: handleRegisterIndexer
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - RegisterIndexer(address indexed indexer, uint256 amount, bytes32 metadata)
        - handler: handleUnregisterIndexer
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - UnregisterIndexer(address indexed indexer);
        - handler: handleUpdateIndexerMetadata
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - UpdateMetadata(address indexed indexer, bytes32 metadata)
        - handler: handleSetControllerAccount
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - SetControllerAccount(address indexed indexer, address indexed controller)
        - handler: handleRemoveControllerAccount
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - RemoveControllerAccount(address indexed indexer, address indexed controller)
        - handler: handleSetCommissionRate
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - SetCommissionRate(address indexed indexer, uint256 amount)
  - <<: *moonbeam
    processor:
      <<: *moonbeam-processor
      options:
        abi: staking
        address: '0x2F50025987C58549018841e007c61759d8Fb9BeD'
    mapping:
      file: ./dist/index.js
      handlers:
        - handler: handleAddDelegation
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - DelegationAdded(address indexed source, address indexed indexer, uint256 amount)
        - handler: handleRemoveDelegation
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - DelegationRemoved(address indexed source, address indexed indexer, uint256 amount)
        - handler: handleWithdrawRequested
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - UnbondRequested(address indexed source, address indexed indexer, uint256 amount, uint256 index)
        - handler: handleWithdrawClaimed
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - UnbondWithdrawn(address indexed source, uint256 amount, uint256 index)
  - <<: *moonbeam
    processor:
      <<: *moonbeam-processor
      options:
        abi: queryRegistry
        address: '0x778F2EbDec0F19bae9dE190f51837176208EbC96'
    mapping:
      file: ./dist/index.js
      handlers:
        - handler: handleNewQuery
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - CreateQuery(uint256 queryId, address creator, bytes32 metadata, bytes32 deploymentId, bytes32 version)
        - handler: handleUpdateQueryMetadata
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - UpdateQueryMetadata(address owner, uint256 queryId, bytes32 metadata)
        - handler: handleUpdateQueryDeployment
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - UpdateQueryDeployment(address owner, uint256 queryId, bytes32 deploymentId, bytes32 version)
        - handler: handleStartIndexing
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - StartIndexing(address indexer, bytes32 deploymentId)
        - handler: handleIndexingUpdate
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - UpdateDeploymentStatus(address indexer, bytes32 deploymentId, uint256 blockheight, bytes32 mmrRoot, uint256 timestamp)
        - handler: handleIndexingReady
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - UpdateIndexingStatusToReady(address indexer, bytes32 deploymentId)
        - handler: handleStopIndexing
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - StopIndexing(address indexer, bytes32 deploymentId)
        - handler: handleUnregisterQuery
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - UnregisterQuery(address indexed owner, uint256 indexed queryId)
  - <<: *moonbeam
    processor:
      <<: *moonbeam-processor
      options:
        abi: planManager
        # address: '0x778F2EbDec0F19bae9dE190f51837176208EbC96'
    mapping:
      file: ./dist/index.js
      handlers:
        - handler: handlePlanTemplateCreated
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - PlanTemplateCreated(uint256 indexed planTemplateId)
        - handler: handlePlanTemplateMetadataUpdated
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - PlanTemplateMetadataChanged(uint256 indexed planTemplateId, bool active)
        - handler: handlePlanTemplateStatusUpdated
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - PlanTemplateStatusChanged(uint256 indexed planTemplateId, bool active);
        - handler: handlePlanCreated
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - PlanCreated(address indexed creator, bytes32 indexed deploymentId, uint256 planTemplateId, uint256 planId, uint256 price)
        - handler: handlePlanRemoved
          kind: substrate/MoonbeamEvent
          filter:
            topics:
              - PlanRemoved(address indexed source, uint256 id, bytes32 deploymentId)
